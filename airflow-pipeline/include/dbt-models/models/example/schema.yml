version: 2

models:
  - name: Star_Schema
    description: "Intermediate model that joins all source tables. It creates a single, wide table of enriched event data that serves as a base for all KPI models."
    columns:
      - name: event_sk
        description: "The surrogate primary key for each event, generated by hashing session, user, product, and event type."
        tests:
          - unique
          - not_null

      - name: price
        description: "The price of the product associated with the event."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0" 

      - name: event_type
        description: "The type of event (e.g., view, cart, purchase)."
        tests:
          - accepted_values:
              values: ['view', 'cart', 'purchase'] 

      - name: session_duration_seconds
        description: "The total duration of the user's session in seconds."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0" 

  - name: Total_Sales_Brand
    description: "Final KPI model calculating sales metrics for the top 10 brands."
    columns:
      - name: brand
        description: "The brand name. This is the primary key for this model."
        tests:
          - unique
          - not_null

      - name: total_sales
        description: "The total revenue generated from purchases for the brand."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0" 

      - name: total_purchases
        description: "The total count of purchase events for the brand."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0" 

  - name: kpi_Daily_Active_Users
    description: "Calculates the number of unique active users for each day. The grain of this table is one row per day."
    columns:
      - name: event_date
        description: "The date for which the active user count is calculated. This is the primary key."
        tests:
          - unique
          - not_null

      - name: daily_active_users
        description: "The count of distinct users on that day."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0" 

  - name: sales_by_brand
    description: "Calculates total revenue, total purchases, and AOV for the top 10 brands. The grain is one row per brand."
    columns:
      - name: brand
        description: "The brand name. This is the primary key."
        tests:
          - unique
          - not_null

      - name: total_revenue
        description: "The sum of the price for all purchase events for the brand."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0" 

      - name: total_purchases
        description: "The count of distinct purchase events for the brand."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0" 

      - name: average_order_value
        description: "The average revenue per purchase event for the brand."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0" 
  - name: daily_summary
    description: "Calculates daily metrics including Daily Active Users (DAU) and total purchases."
    columns:
      - name: event_date
        description: "The date for which the metrics are calculated. This is the primary key."
        tests:
          - unique
          - not_null
      - name: daily_active_users
        description: "The count of distinct users on that day."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: total_purchases
        description: "The total count of purchase events on that day."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

  - name: top_brands_by_sales
    description: "Calculates total revenue for the top 10 brands."
    columns:
      - name: brand
        description: "The brand name. This is the primary key."
        tests:
          - unique
          - not_null
      - name: total_revenue
        description: "The sum of the price for all purchase events for the brand."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

  - name: top_categories_by_sales
    description: "Calculates total revenue for the top 10 product categories."
    columns:
      - name: category_code
        description: "The category code. This is the primary key."
        tests:
          - unique
          - not_null
      - name: total_revenue
        description: "The sum of the price for all purchase events for the category."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

  - name: conversion_rate
    description: "A summary table with one row, calculating key conversion rates across all sessions."
    columns:
      - name: view_to_purchase_conversion_rate
        description: "The percentage of sessions with a purchase out of all sessions with a view."
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"
      - name: cart_to_purchase_rate
        description: "The percentage of sessions with a purchase out of all sessions that added to cart."
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"

  - name: overall_metrics
    description: "A summary table with one row, calculating site-wide metrics like AOV and Cart Abandonment Rate."
    columns:
      - name: average_order_value
        description: "The average revenue per purchase session (order)."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: cart_abandonment_rate
        description: "The percentage of sessions that added to cart but did not complete a purchase."
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"
            